<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snack products - Ricerca</title>
  <style>
    /* --- Stili invariati --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 1.1em;
    }

    .user-id-display {
      background: #f0f0f0;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 30px;
      font-size: 0.9em;
      color: #666;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .product-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 25px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .product-image {
      width: 100%;
      height: 200px;
      background: #f5f5f5;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-image .emoji-fallback {
      font-size: 4em;
    }

    .product-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .product-description {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .product-price {
      font-size: 1.5em;
      color: #667eea;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .btn-add-cart {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-add-cart:hover {
      background: #5568d3;
      transform: scale(1.02);
    }

    .btn-add-cart.added {
      background: #48bb78;
    }

    .cart-summary {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .cart-summary h2 {
      color: #333;
      margin-bottom: 15px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .cart-total {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
      margin-top: 15px;
      text-align: right;
    }

    .admin-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9em;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    .admin-panel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 2000;
    }

    .admin-panel.active {
      display: block;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    .tracking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .tracking-table th,
    .tracking-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .tracking-table th {
      background: #f8f9fa;
      font-weight: bold;
    }

    .btn-export {
      background: #48bb78;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 20px;
    }

    .btn-export:hover {
      background: #38a169;
    }

    .empty-cart {
      text-align: center;
      color: #999;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>The Aurum Store</h1>
    <p class="subtitle">All our products are made with 100% Natural Ingredients </p>

    <div class="user-id-display" id="userIdDisplay">Caricamento ID utente...</div>

    <div class="cart-summary">
      <h2>ðŸ›’ Cart</h2>
      <div id="cartItems" class="empty-cart">Your cart is empty</div>
      <div class="cart-total" id="cartTotal"></div>
    </div>

    <div class="products-grid" id="productsGrid"></div>
  </div>

  <script>
    const products = [
      {
        id: 1,
        name: 'Galbusera Zalet Biscuits',
        price: 2.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003726_galbusera-zalet-biscotto-con-malto-e-miele-510g_550.jpeg'
      },
      {
        id: 2,
        name: 'Galbusera TheFroll Biscuits',
        price: 2.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003717_galbusera-thefroll-biscotto-con-zucchero-di-canna-e-miele-400g_550.jpeg'
      },
      {
        id: 3,
        name: 'Galbusera Valtellina Biscuits',
        price: 2.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003832_galbusera-valtellina-biscotto-con-latte-intero-fresco-pastorizzato-500g_550.jpeg'
      },
      {
        id: 4,
        name: 'Tre Marie Nougal',
        price: 1.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003537_wafer-stracciatella-ancora-uno-tre-marie-140g_550.png'
      },
      {
        id: 5,
        name: 'Tre Marie Avel',
        price: 1.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003542_wafer-nocciolato-ancora-uno-tre-marie-140g_550.png'
      },
      {
        id: 6,
        name: 'Tre Marie Migdal',
        price: 1.50,
        emoji: 'ðŸª',
        description: 'Made with 100% Natural Ingredients',
        image: 'https://static.galbusera.it/media/0003539_wafer-mandorlato-ancora-uno-tre-marie-140g_550.png'
      }
    ];

    let userId = null;
    let trackingData = [];
    let cart = [];
    let sessionStart = Date.now();

    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxBrY5SfRI3r7MY9tRGTn6-eQFHh9uYQkpWQ8jdLmOZ4ltrPN6y_2L3M82gFijAAEhEnQ/exec';

    function getUserIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('uid') || urlParams.get('user_id') || urlParams.get('PROLIFIC_PID') || 'DEMO_' + Date.now();
    }

    function init() {
      userId = getUserIdFromURL();
      document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
      trackEvent('session_start', null, null);
      renderProducts();
      updateCart();
    }

    function trackEvent(eventType, productId, productPrice) {
      const now = new Date();
      const timestamp = now.toLocaleString('it-IT', { hour12: false });

      const event = {
        timestamp,
        userId,
        eventType,
        productId,
        productName: productId ? products.find(p => p.id === productId).name : null,
        productPrice,
        sessionDuration: Math.floor((Date.now() - sessionStart) / 1000)
      };

      trackingData.push(event);
      console.log('Event tracked:', event);

      sendToGoogleSheets(event);
      updateTrackingTable();
    }

    function sendToGoogleSheets(event) {
      fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(event)
      })
        .then(() => console.log('âœ… Dati inviati a Google Sheets'))
        .catch(error => console.error('âŒ Errore invio a Google Sheets:', error));
    }

    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = products
        .map(product => {
          const imageHTML = product.image
            ? `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div class="emoji-fallback" style="display:none;">${product.emoji}</div>`
            : `<div class="emoji-fallback">${product.emoji}</div>`;
          return `
            <div class="product-card" onclick="viewProduct(${product.id})">
              <div class="product-image">${imageHTML}</div>
              <div class="product-name">${product.name}</div>
              <div class="product-description">${product.description}</div>
              <div class="product-price">$${product.price.toFixed(2)}</div>
              <button class="btn-add-cart" onclick="addToCart(event, ${product.id})" id="btn-${product.id}">
                ADD TO CART
              </button>
            </div>`;
        })
        .join('');
    }

    function viewProduct(productId) {
      const product = products.find(p => p.id === productId);
      trackEvent('product_view', productId, product.price);
    }

    function addToCart(event, productId) {
      event.stopPropagation();
      const product = products.find(p => p.id === productId);
      const existingItem = cart.find(item => item.id === productId);
      if (existingItem) existingItem.quantity++;
      else cart.push({ ...product, quantity: 1 });
      trackEvent('add_to_cart', productId, product.price);
      updateCart();
      const btn = document.getElementById(`btn-${productId}`);
      btn.classList.add('added');
      btn.textContent = 'âœ“ Aggiunto';
      setTimeout(() => {
        btn.classList.remove('added');
        btn.textContent = 'ADD TO CART';
      }, 1500);
    }

    function updateCart() {
      const cartItemsDiv = document.getElementById('cartItems');
      const cartTotalDiv = document.getElementById('cartTotal');
      if (cart.length === 0) {
        cartItemsDiv.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
        cartTotalDiv.textContent = '';
        return;
      }
      cartItemsDiv.innerHTML = cart
        .map(item => `
          <div class="cart-item">
            <span>${item.name} x${item.quantity}</span>
            <span>$${(item.price * item.quantity).toFixed(2)}</span>
          </div>`)
        .join('');
      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      cartTotalDiv.textContent = `Total: $${total.toFixed(2)}`;
    }

    function toggleAdmin() {
      document.getElementById('adminPanel').classList.toggle('active');
      document.getElementById('overlay').classList.toggle('active');
    }

    function updateTrackingTable() {
      const tbody = document.getElementById('trackingBody');
      document.getElementById('eventCount').textContent = trackingData.length;
      tbody.innerHTML = trackingData
        .slice()
        .reverse()
        .map(
          e => `
          <tr>
            <td>${e.timestamp}</td>
            <td>${e.userId}</td>
            <td>${e.eventType}</td>
            <td>${e.productName || '-'}</td>
            <td>${e.productPrice ? '$' + e.productPrice.toFixed(2) : '-'}</td>
          </tr>`
        )
        .join('');
    }

    function exportCSV() {
      const headers = ['Timestamp', 'UserID', 'EventType', 'ProductID', 'ProductName', 'ProductPrice', 'SessionDuration'];
      const rows = trackingData.map(e => [
        e.timestamp,
        e.userId,
        e.eventType,
        e.productId || '',
        e.productName || '',
        e.productPrice || '',
        e.sessionDuration
      ]);
      const csv = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `tracking_${userId}_${Date.now()}.csv`;
      link.click();
    }

    window.addEventListener('beforeunload', () => trackEvent('session_end', null, null));

    init();
  </script>
</body>
</html>
